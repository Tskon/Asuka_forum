<?phpadd_filter('pfm_options_forum','pra_add_role_option', 10, 2);function pra_add_role_option($options, $forum){        $PFMRoles = new PrimeRoles();        $values = array();    foreach($PFMRoles->roles as $role => $prop){        if($role == 'ban') continue;        $values[$role] = $prop['name'];    }        $roleAccess = array();    if($forum){        $roleAccess = pfm_get_meta($forum->forum_id,'forum','role_access');    }        $options[] = array(        'type' => 'checkbox',        'title' => __('Приватный доступ'),        'notice' => __('Укажите роли для которых доступ к форуму будет открыт. Если ничего не указано, то доступ открыт для всех.'),        'slug' => 'role_access',        'values' => $values,        'default' => $roleAccess    );        return $options;    }add_action('pfm_update_forum', 'pra_update_role_access', 10);add_action('pfm_add_forum', 'pra_update_role_access', 10);function pra_update_role_access($forum_id){        if(isset($_POST['pfm-data']) && $_POST['pfm-data']['action'] == 'topic_create') return false;         $newRoles = array();        if((isset($_POST['role_access']) && $_POST['role_access'])){        $newRoles = $_POST['role_access'];    }        $roleAccess = pfm_get_meta($forum_id,'forum','role_access');        if(!$roleAccess && !$newRoles) return false;        if(!$newRoles){        pfm_delete_meta($forum_id,'forum','role_access');    }else{        pfm_update_meta($forum_id,'forum','role_access',$newRoles);    } }add_action('pfm_after_init_query','pra_init_icons');function pra_init_icons(){    global $PraIcons,$PrimeQuery;        if(pfm_is_group() || pfm_is_home()){                if(!$PrimeQuery->forums) return false;                $forumIds = array();        foreach($PrimeQuery->forums as $forum){            $forumIds[] = $forum->forum_id;        }                $icons = pfm_get_metas(array(            'object_id__in' => $forumIds,            'object_type' => 'forum',            'meta_key' => 'role_access',            'fields' => array(                'meta_value',                'object_id'            )        ));                $PraIcons = array();        foreach($icons as $icon){            $PraIcons[$icon->object_id] = $icon->meta_value;        }            }}add_filter('pfm_check_forum_errors','pra_check_access_global_view', 10, 2);function pra_check_access_global_view($errors, $data){        if(!$data->is_forum && !$data->is_topic) return $errors;        $forum_id = $data->object->forum_id;        $roleAccess = pfm_get_meta($forum_id,'forum','role_access');        if(!$roleAccess) return $errors;        $PrimeUser = new PrimeUser();        if(!in_array($PrimeUser->user_role, $roleAccess))        $errors['error'][] = __('Приватный форум. Вам запрещено просматривать содержимое этого форума.');        return $errors;}add_filter('pfm_icons', 'pra_add_icon');function pra_add_icon($icons){    global $PraIcons,$PrimeForum;        if(pfm_is_group() || pfm_is_home()){                $IdsAccess = (isset($PraIcons[$PrimeForum->forum_id]))? $PraIcons[$PrimeForum->forum_id]: false;            if($IdsAccess){            $icons[] = 'fa-user-secret';        }        }        return $icons;    }